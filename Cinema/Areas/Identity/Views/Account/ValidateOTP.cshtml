@model Cinema.ViewModels.ValidateOTPVM
@{
    ViewData["Title"] = "Verify OTP";
}

<div class="container_email_confirmation">
    <div class="email-confirmation-card">
        <div class="card-icon">
            <i class="fas fa-lock"></i>
        </div>

        <h1>Enter Verification Code</h1>
        <p class="subtitle">We've sent a 6-digit OTP code to <strong>@Model.Email</strong>. Please enter it below.</p>

        <form asp-action="ValidateOTP" asp-controller="Account" asp-area="Identity" method="post" id="otpForm">
            <input type="hidden" asp-for="ApplicationUserId" />
            <input type="hidden" asp-for="Email" />

            <div class="form-content">
                <div class="otp-container">
                    <input type="text" maxlength="1" class="otp-input" id="otp1" pattern="[0-9]" required />
                    <input type="text" maxlength="1" class="otp-input" id="otp2" pattern="[0-9]" required />
                    <input type="text" maxlength="1" class="otp-input" id="otp3" pattern="[0-9]" required />
                    <input type="text" maxlength="1" class="otp-input" id="otp4" pattern="[0-9]" required />
                    <input type="text" maxlength="1" class="otp-input" id="otp5" pattern="[0-9]" required />
                    <input type="text" maxlength="1" class="otp-input" id="otp6" pattern="[0-9]" required />
                </div>

                <input type="hidden" asp-for="OTP" id="fullOtp" />
                <span asp-validation-for="OTP" class="text-danger"></span>

                <button type="submit" class="btn-primary">
                    <i class="fas fa-check"></i>
                    Verify Code
                </button>

                <div class="resend-container">
                    <p>Didn't receive the code?</p>
                    <a asp-action="ForgotPassword" asp-controller="Account" asp-area="Identity" class="resend-link" id="resendLink">
                        <i class="fas fa-redo"></i>
                        Resend OTP (<span id="timer">60</span>s)
                    </a>
                </div>

                <div class="divider">
                    <span>or</span>
                </div>

                <a asp-action="ForgotPassword" asp-controller="Account" asp-area="Identity" class="back-link">
                    <i class="fas fa-arrow-left"></i>
                    Try Another Email
                </a>
            </div>
        </form>

        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i>
                @TempData["ErrorMessage"]
            </div>
        }

        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                @TempData["SuccessMessage"]
            </div>
        }
    </div>

    <div class="info-panel">
        <div class="info-content">
            <h2>Tips for OTP</h2>
            <ul class="info-list">
                <li>
                    <i class="fas fa-inbox"></i>
                    <span>Check your spam/junk folder if you don't see the email</span>
                </li>
                <li>
                    <i class="fas fa-clock"></i>
                    <span>The code expires in 10 minutes</span>
                </li>
                <li>
                    <i class="fas fa-redo"></i>
                    <span>You can request a new code after 60 seconds</span>
                </li>
            </ul>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        const otpInputs = document.querySelectorAll('.otp-input');
        const fullOtpInput = document.getElementById('fullOtp');
        const otpForm = document.getElementById('otpForm');

        otpInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
                if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
                updateFullOtp();
                if (index === 5 && e.target.value.length === 1) {
                    const allFilled = Array.from(otpInputs).every(inp => inp.value.length === 1);
                    if (allFilled) setTimeout(() => otpForm.submit(), 300);
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && !e.target.value && index > 0) {
                    otpInputs[index - 1].focus();
                    otpInputs[index - 1].value = '';
                    updateFullOtp();
                }
            });

            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text').replace(/[^0-9]/g, '').slice(0, 6);
                pastedData.split('').forEach((char, i) => {
                    if (otpInputs[i]) otpInputs[i].value = char;
                });
                updateFullOtp();
                if (pastedData.length === 6) {
                    otpInputs[5].focus();
                    setTimeout(() => otpForm.submit(), 300);
                } else {
                    otpInputs[Math.min(pastedData.length, 5)].focus();
                }
            });
        });

        function updateFullOtp() {
            const otp = Array.from(otpInputs).map(input => input.value).join('');
            fullOtpInput.value = otp;
        }

        let timeLeft = 60;
        const resendLink = document.getElementById('resendLink');
        const timerSpan = document.getElementById('timer');
        resendLink.classList.add('disabled');

        const countdown = setInterval(() => {
            timeLeft--;
            timerSpan.textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(countdown);
                resendLink.classList.remove('disabled');
                resendLink.innerHTML = '<i class="fas fa-redo"></i> Resend OTP';
            }
        }, 1000);

        otpInputs[0].focus();
    </script>
}
